# 爬虫实例

python爬虫实例代码

```python
#  -*- coding: utf-8 -*-

import urllib.request
import http.cookies
import http.cookiejar
import urllib.parse
import urllib
import time
import random
from bs4 import BeautifulSoup

public_header = {
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.75 Safari/537.36",
    "Cache-Control": "no-cache",
    "Connection": "keep-alive"
}


cookie = http.cookiejar.CookieJar()
handle = urllib.request.HTTPCookieProcessor(cookie)
opener = urllib.request.build_opener(handle)

homepage = urllib.request.Request("http://jwgl.mju.edu.cn/default2.aspx")

homepageResponse = opener.open(homepage)
homepageContent = homepageResponse.read().decode('gbk')

for cookieitem in cookie:
    print(cookieitem)
# print(homepageResponse.read().decode('gbk'))

# 取得验证码
#<img id="icode" src="CheckCode.aspx" onclick="reloadcode();" alt="看不清，换一张" title="看不清，换一张" alt="" border="0" style="POSITION:absolute;TOP:5px;LEFT:130px" />

soup = BeautifulSoup(homepageContent, 'html.parser')
sycode_src = "http://jwgl.mju.edu.cn/"+soup.find('img', id='icode')['src']
view_status = soup.findAll('input')
for view_status_item in view_status:
    if(view_status_item['name'] == "__VIEWSTATE"):
        view_status = view_status_item['value']
        break
print(view_status)
streamForCodeImg = opener.open(sycode_src).read()
local = open("code.jpeg", 'wb')
local.write(streamForCodeImg)
local.close()

# urllib.request.urlretrieve(sycode_src,"code.jpeg")

sycode_str = input("输入验证码(保存位置code.jpeg):")
username = "5157101119"
password = "CYQ19931115"

login_post = {
    "__VIEWSTATE": view_status,
    "txtUserName": username,
    "TextBox2": password,
    "txtSecretCode": sycode_str,
    "RadioButtonList1": r"%D1%A7%C9%FA",
    "Button1": "",
    "lbLanguage": "",
    "hidPdrs": "",
    "hidsc": ""
}

# print(login_post)
login_post = urllib.parse.urlencode(login_post).encode("gbk")
login_request = urllib.request.Request(
    "http://jwgl.mju.edu.cn/default2.aspx", login_post, public_header)
# post
login_request.add_header("Content-Type", "application/x-www-form-urlencoded")
loginResponse = opener.open(login_request)
loginHomePage = loginResponse.read().decode('gbk')

# 登陆完成

# 获取__ViewState状态码
search_page = opener.open(urllib.request.Request(
    r"http://jwgl.mju.edu.cn/xscjcx.aspx?xh=5157101119&xm=%B3%C2%D3%B3%E1%BD&gnmkdm=N121617"))
search_page_content = search_page.read().decode('gbk')

soup = BeautifulSoup(search_page_content, "html.parser")
view_status = soup.findAll('input')
for view_status_item in view_status:
    if(view_status_item['name'] == "__VIEWSTATE"):
        view_status = view_status_item['value']
        break

count=0
while True:
    count=count+1;
    time.sleep(3)
    # print(loginHomePage)
    # 学期成绩查询
    post_seacher = {
        "__EVENTTARGET": "",
        "__EVENTARGUMENT": "",
        "__VIEWSTATE": view_status,
        "hidLanguage": "",
        "ddlXN": "2015-2016",  # 学期
        "ddlXQ": "2",  # 学年
        "ddl_kcxz": "",
        "btn_xq": r"%D1%A7%C6%DA%B3%C9%BC%A8"
    }
    post_seacher = urllib.parse.urlencode(post_seacher).encode("gbk")
    score_request = urllib.request.Request(
        r"http://jwgl.mju.edu.cn/xscjcx.aspx?xh=5157101119&xm=%B3%C2%D3%B3%E1%BD&gnmkdm=N121617", post_seacher, public_header)
    score_request.add_header("Content-Type", "application/x-www-form-urlencoded")
    score = opener.open(score_request)
    score_content = score.read().decode("gbk")
    # print(score_content)
    soup = BeautifulSoup(score_content, "html.parser")
    get_username = soup.find(id='lbl_xm').get_text()
    get_student_number = soup.find(id='lbl_xh').get_text()
    # 遍历表格
    print("============================       ",count,"        ===============================")
    score_table = soup.find(id="Datagrid1").children
    i = 0
    for item in score_table:
        print("     ")
        if (i >= 2):
            k=0
            for tr in item:
                if (k==4 or k==9):
                    print(tr)
                k=k+1
        i = i+1
```